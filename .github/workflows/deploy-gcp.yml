name: deploy-gcp

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  TF_STATE_BUCKET: ${{ vars.GCP_TF_STATE_BUCKET }}
  TF_STATE_PREFIX: ${{ vars.GCP_TF_STATE_PREFIX }}
  RUN_ALLOW_UNAUTHENTICATED: ${{ vars.GCP_RUN_ALLOW_UNAUTHENTICATED }}

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_DEPLOYER_SERVICE_ACCOUNT }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Maven build
        run: mvn clean package -DskipTests

      - name: Terraform init
        working-directory: infra/terraform
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=${TF_STATE_PREFIX}"

      - name: Terraform fmt check
        working-directory: infra/terraform
        run: terraform fmt -check -recursive

      - name: Terraform validate
        working-directory: infra/terraform
        run: terraform validate

  deploy:
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_DEPLOYER_SERVICE_ACCOUNT }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Maven build
        run: mvn clean package -DskipTests

      - name: Terraform init
        working-directory: infra/terraform
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=${TF_STATE_PREFIX}"

      - name: Terraform apply (base infra)
        working-directory: infra/terraform
        run: |
          terraform apply -auto-approve \
            -var="project_id=${PROJECT_ID}" \
            -var="region=${REGION}" \
            -var="weekly_function_url="

      - name: Capture Terraform outputs
        id: tf
        working-directory: infra/terraform
        run: |
          echo "api_sa=$(terraform output -raw api_feedback_service_account_email)" >> "$GITHUB_OUTPUT"
          echo "notif_sa=$(terraform output -raw notificacao_service_account_email)" >> "$GITHUB_OUTPUT"
          echo "relatorio_sa=$(terraform output -raw relatorio_service_account_email)" >> "$GITHUB_OUTPUT"
          echo "topic=$(terraform output -raw pubsub_topic_critico)" >> "$GITHUB_OUTPUT"
          echo "collection=$(terraform output -raw firestore_collection)" >> "$GITHUB_OUTPUT"

      - name: Deploy API (Cloud Run)
        run: |
          AUTH_FLAG="--no-allow-unauthenticated"
          if [[ "${RUN_ALLOW_UNAUTHENTICATED,,}" == "true" ]]; then
            AUTH_FLAG="--allow-unauthenticated"
          fi

          gcloud run deploy api-feedback \
            --project "${PROJECT_ID}" \
            --region "${REGION}" \
            --source api-feedback \
            --service-account "${{ steps.tf.outputs.api_sa }}" \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=${PROJECT_ID},GCP_PROJECT_ID=${PROJECT_ID},GCP_FIRESTORE_COLLECTION=${{ steps.tf.outputs.collection }},GCP_PUBSUB_TOPIC_CRITICO=${{ steps.tf.outputs.topic }}" \
            "${AUTH_FLAG}"

      - name: Deploy função notificacao critica (Gen2 / PubSub)
        run: |
          gcloud functions deploy notificacao-critica \
            --gen2 \
            --runtime java17 \
            --project "${PROJECT_ID}" \
            --region "${REGION}" \
            --source functions/notificacao-critica \
            --entry-point br.com.techchallenge.fase4.functions.notificacao.CriticalNotificationFunction \
            --trigger-topic "${{ steps.tf.outputs.topic }}" \
            --service-account "${{ steps.tf.outputs.notif_sa }}"

      - name: Deploy função relatorio semanal (Gen2 / HTTP)
        run: |
          gcloud functions deploy relatorio-semanal \
            --gen2 \
            --runtime java17 \
            --project "${PROJECT_ID}" \
            --region "${REGION}" \
            --source functions/relatorio-semanal \
            --entry-point br.com.techchallenge.fase4.functions.relatorio.WeeklyReportFunction \
            --trigger-http \
            --service-account "${{ steps.tf.outputs.relatorio_sa }}" \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=${PROJECT_ID},FIRESTORE_COLLECTION=${{ steps.tf.outputs.collection }}"

      - name: Read URL da função de relatório
        id: relatorio
        run: |
          url=$(gcloud functions describe relatorio-semanal \
            --gen2 \
            --project "${PROJECT_ID}" \
            --region "${REGION}" \
            --format='value(serviceConfig.uri)')
          echo "url=${url}" >> "$GITHUB_OUTPUT"

      - name: Terraform apply (scheduler com URL final)
        working-directory: infra/terraform
        run: |
          terraform apply -auto-approve \
            -var="project_id=${PROJECT_ID}" \
            -var="region=${REGION}" \
            -var="weekly_function_url=${{ steps.relatorio.outputs.url }}"
